/*
 *  fl#valid - File-structure validity
 *  Copyright (C) 2016  Fredrik Lindgren, a.k.a., Wisp
 *
 *  This script is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version. The following additional
 *  permissions apply:
 *
 *  Section 4: Conveying Verbatim Copies
 *  You are only required to retain any existing notices of copyright
 *  and absence of warranty.
 *
 *  This script is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this script.  If not, see <http://www.gnu.org/licenses/>.
 *
 */

/*********************************************************************
 * Public interface
 ********************************************************************/

DEFINE_PATCH_FUNCTION fl#valid
  RET
    valid
BEGIN
  LPF fl#valid#signature RET signature END
  PATCH_MATCH "%signature%" WITH

    DEFAULT
      PATCH_PRINT "fl#valid does not support buffers of type %signature%"
  END
END

DEFINE_ACTION_FUNCTION fl#valid
  STR_VAR
    file = ""
  RET
    valid
BEGIN
  ACTION_IF "%file%" STR_CMP "" AND FILE_EXISTS_IN_GAME "%file%" BEGIN
    COPY_EXISTING "%file%" override
      LPF fl#valid RET valid END
    BUT_ONLY
  END ELSE WARN "WARNING: fl#valid cannot determine validity of non-existent file %file%"
END

/*********************************************************************
 * Private interface
 ********************************************************************/

DEFINE_PATCH_FUNCTION fl#valid#signature
  RET
    signature
    version
BEGIN
  READ_ASCII 0 signature ELSE "0-byte file" (4)
  READ_ASCII 4 version ELSE "0-byte file" (4)
END
